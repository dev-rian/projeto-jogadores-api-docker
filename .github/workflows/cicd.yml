name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  # ETAPA 1: Testes (CI) [cite: 13]
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt

      - name: Rodar Testes
        run: |
          # Adiciona o diretório atual ao PYTHONPATH para o teste achar o 'app'
          export PYTHONPATH=$PYTHONPATH:.
          pytest

  # ETAPA 2: Build & Push Docker (CD Parte 1) [cite: 4]
  build-and-push:
    needs: test # Só roda se os testes passarem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Login no Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build e Push da Imagem
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          # Tags: latest e o SHA do commit (para versionamento)
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/futebol-api:latest
            ${{ secrets.DOCKER_USERNAME }}/futebol-api:${{ github.sha }}

  # ETAPA 3: Deploy no Servidor (CD Parte 2) [cite: 47]
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3
      
      - name: Copiar arquivos via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          # Copiamos apenas o necessário para rodar
          source: "docker-compose.prod.yml,db_init"
          target: "/home/${{ secrets.USERNAME }}/app"

      - name: Executar Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd /home/${{ secrets.USERNAME }}/app
            
            # Exporta o usuário para o docker-compose usar
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            
            # Baixa a nova imagem
            docker compose -f docker-compose.prod.yml pull
            
            # Recria os containers (apenas se mudou algo)
            docker compose -f docker-compose.prod.yml up -d